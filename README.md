# FiapPostTechPayments - Microservi√ßo de Pagamentos

Microservi√ßo de processamento de pagamentos e transa√ß√µes com **observabilidade completa** implementando:
- üí≥ **Processamento de Pagamentos**: M√∫ltiplos m√©todos de pagamento e gateways
- üìä **Distributed Tracing**: OpenTelemetry + Jaeger para rastreamento distribu√≠do
- üìà **Monitoramento**: Prometheus + Grafana + ELK Stack
- üöÄ **Infraestrutura**: Docker containerizado com health checks

## üéØ **Como o Microservi√ßo Payments est√° Funcionando**

O sistema utiliza arquitetura limpa para:
- **üí≥ Pagamentos**: Cart√£o de cr√©dito, d√©bito, PIX, boleto banc√°rio
- **üîÑ Transa√ß√µes**: Processamento ass√≠ncrono com estados controlados
- **üí∞ Financeiro**: C√°lculo de taxas, parcelamentos e estornos
- **üìä Relat√≥rios**: Analytics financeiros e reconcilia√ß√£o
- **‚ö° Performance**: Processamento otimizado com retry policies

### **üèóÔ∏è Arquitetura do Microservi√ßo**
- **Domain Layer**: Entidades financeiras, regras de neg√≥cio e valida√ß√µes
- **Application Layer**: Servi√ßos de pagamento, DTOs e processadores
- **Infrastructure Layer**: Gateways de pagamento e persist√™ncia
- **API Layer**: Controllers de transa√ß√µes e webhooks
- **Payment Gateways**: Integra√ß√£o com provedores externos
- **Observabilidade**: OpenTelemetry integration completa

### **üîç Observabilidade & Distributed Tracing**
- **OpenTelemetry**: Instrumenta√ß√£o autom√°tica de HTTP requests e ASP.NET Core
- **Jaeger**: Visualiza√ß√£o de traces distribu√≠dos na porta 16686
- **Service Name**: "Payments.Api" para identifica√ß√£o no tracing
- **Transaction Tracing**: Rastreamento completo do fluxo de pagamento
- **Performance Monitoring**: Medi√ß√£o de lat√™ncia e identifica√ß√£o de gargalos
- **Gateway Monitoring**: Monitoramento de integra√ß√µes externas

## üöÄ **Como Iniciar**

### **1. Pr√©-requisitos**
```bash
# Ferramentas necess√°rias
- Docker Desktop
- .NET 8 SDK
- Git
```

### **2. Infraestrutura (Docker)**
```bash
# 1. Navegar para o diret√≥rio de infraestrutura
cd ../FiapPostTechDocker

# 2. Subir infraestrutura completa
docker-compose up -d sqlserver elasticsearch kibana logstash prometheus grafana jaeger rabbitmq

# 3. Verificar containers rodando
docker ps
# Deve mostrar: sqlserver (1433), elasticsearch (9200), jaeger (16686), prometheus (9090), etc.

# 4. Testar servi√ßos principais
curl http://localhost:9200     # Elasticsearch
curl http://localhost:16686    # Jaeger UI
curl http://localhost:9090     # Prometheus
curl http://localhost:3000     # Grafana
```

### **3. Aplica√ß√£o (.NET)**
```bash
# 1. Navegar para a API
cd src/Payments.Api

# 2. Restaurar pacotes
dotnet restore

# 3. Executar aplica√ß√£o
dotnet run
# Aplica√ß√£o dispon√≠vel em: http://localhost:9201
# Swagger dispon√≠vel em: http://localhost:9201/swagger
```

### **4. Inicializa√ß√£o Autom√°tica**
A aplica√ß√£o faz automaticamente:
- ‚úÖ **Aplica√ß√£o de migrations**: DatabaseStructure + dados iniciais
- ‚úÖ **Configura√ß√£o de Gateways**: Setup dos provedores de pagamento
- ‚úÖ **Setup RabbitMQ**: Queues para processamento ass√≠ncrono
- ‚úÖ **Health checks**: Monitoramento de depend√™ncias

## üí≥ **Sistema de Pagamentos**

### **Criar Transa√ß√£o**
```http
POST /api/v1/payments/transactions
```
**Fun√ß√£o**: Inicia nova transa√ß√£o de pagamento com valida√ß√µes completas.
**M√©todos**: Cart√£o, PIX, boleto, d√©bito.
**Valida√ß√µes**: Dados do cart√£o, limites, disponibilidade.

### **Consultar Transa√ß√£o**
```http
GET /api/v1/payments/transactions/{id}
```
**Fun√ß√£o**: Retorna detalhes completos da transa√ß√£o.
**Estados**: Pendente, Processando, Aprovado, Rejeitado, Cancelado.

### **Processar Pagamento**
```http
POST /api/v1/payments/process/{transactionId}
```
**Fun√ß√£o**: Processa pagamento atrav√©s dos gateways configurados.
**Ass√≠ncrono**: Processamento em background com notifica√ß√µes.

### **Webhook de Confirma√ß√£o**
```http
POST /api/v1/payments/webhook/{gateway}
```
**Fun√ß√£o**: Recebe confirma√ß√µes dos gateways de pagamento.
**Seguran√ßa**: Valida√ß√£o de assinatura e autentica√ß√£o.

## üí∞ **Gest√£o Financeira**

### **Calcular Parcelamento**
```http
POST /api/v1/payments/installments/calculate
```
**Fun√ß√£o**: Calcula parcelas com juros e taxas aplic√°veis.
**Par√¢metros**: Valor, quantidade de parcelas, tipo de produto.

### **Processar Estorno**
```http
POST /api/v1/payments/refund/{transactionId}
```
**Fun√ß√£o**: Processa estorno total ou parcial da transa√ß√£o.
**Valida√ß√µes**: Tempo limite, status da transa√ß√£o, motivo.

### **Relat√≥rio de Vendas**
```http
GET /api/v1/payments/reports/sales
```
**Fun√ß√£o**: Relat√≥rio financeiro com vendas por per√≠odo.
**Filtros**: Data, m√©todo de pagamento, status.

### **Concilia√ß√£o Banc√°ria**
```http
GET /api/v1/payments/reconciliation
```
**Fun√ß√£o**: Relat√≥rio de concilia√ß√£o com movimento banc√°rio.
**Uso**: Auditoria e controle financeiro.

## üìä **Analytics e M√©tricas**

### **Dashboard Financeiro**
```http
GET /api/v1/payments/analytics/dashboard
```
**Fun√ß√£o**: KPIs financeiros em tempo real.
**M√©tricas**: Volume, ticket m√©dio, taxa de aprova√ß√£o, m√©todos populares.

### **An√°lise de Performance**
```http
GET /api/v1/payments/analytics/performance
```
**Fun√ß√£o**: Performance dos gateways de pagamento.
**M√©tricas**: Tempo de resposta, taxa de sucesso, erros.

### **Detec√ß√£o de Fraude**
```http
GET /api/v1/payments/analytics/fraud-detection
```
**Fun√ß√£o**: An√°lise de padr√µes suspeitos e tentativas de fraude.
**Algoritmos**: Machine learning para detec√ß√£o automatizada.

## ‚öôÔ∏è **Caracter√≠sticas T√©cnicas**

### **üéØ Arquitetura de Pagamentos**
- **Gateway Pattern**: Abstra√ß√£o para m√∫ltiplos provedores
- **State Machine**: Controle rigoroso de estados das transa√ß√µes
- **Retry Policies**: Tentativas autom√°ticas com backoff exponencial
- **Idempotency**: Preven√ß√£o de cobran√ßas duplicadas
- **Saga Pattern**: Transa√ß√µes distribu√≠das com compensa√ß√£o

### **üí≥ Gateways Suportados**
- **Cart√£o de Cr√©dito**: Visa, Mastercard, American Express
- **Cart√£o de D√©bito**: D√©bito online com autentica√ß√£o
- **PIX**: Integra√ß√£o completa com BACEN
- **Boleto Banc√°rio**: Gera√ß√£o e concilia√ß√£o autom√°tica
- **Carteiras Digitais**: PayPal, Apple Pay, Google Pay

### **üîê Seguran√ßa Financeira**
- **PCI Compliance**: Padr√µes de seguran√ßa para dados de cart√£o
- **Tokenization**: Substitui√ß√£o de dados sens√≠veis por tokens
- **Encryption**: Criptografia AES-256 para dados em tr√¢nsito e repouso
- **Fraud Detection**: Algoritmos de ML para detec√ß√£o de fraude
- **3D Secure**: Autentica√ß√£o adicional para cart√µes

## üîç **Monitoramento e Observabilidade**

### **Health Checks e Observabilidade**
- **`/health`**: Status geral da aplica√ß√£o + gateways
- **`/health/ready`**: Verifica√ß√£o de conectividade com provedores
- **`/health/live`**: Liveness probe para containers
- **`/metrics`**: M√©tricas Prometheus para observabilidade

### **üîç Distributed Tracing Endpoints**
- **Jaeger UI**: `http://localhost:16686` - Visualiza√ß√£o de traces
- **Service Name**: "Payments.Api" - Identifica√ß√£o no Jaeger
- **Transaction Tracing**: Rastreamento completo do fluxo de pagamento
- **Gateway Tracing**: Monitoramento de chamadas para provedores externos

### **üìä Dashboards de Monitoramento**
- **Grafana**: `http://localhost:3000` (admin/admin)
- **Prometheus**: `http://localhost:9090` - M√©tricas coletadas
- **Kibana**: `http://localhost:5601` - Logs centralizados
- **RabbitMQ**: `http://localhost:15672` (guest/guest)

### **üìù Logs Estruturados**
O sistema gera logs estruturados para:
- **Transa√ß√µes**: Cria√ß√£o, processamento, aprova√ß√£o/rejei√ß√£o
- **Gateways**: Chamadas para provedores externos
- **Fraude**: Tentativas suspeitas e bloqueios
- **Performance**: Tempo de resposta e throughput

## üí° **Eventos e Integra√ß√µes**

### **Eventos Publicados**
- **PaymentCreated**: Quando transa√ß√£o √© criada
- **PaymentProcessed**: Quando pagamento √© processado
- **PaymentApproved**: Quando pagamento √© aprovado
- **PaymentRejected**: Quando pagamento √© rejeitado
- **RefundProcessed**: Quando estorno √© processado

### **Consumidores de Eventos**
O microservi√ßo consome eventos de outros servi√ßos para:
- Processar pagamentos de pedidos
- Atualizar status de compras
- Enviar notifica√ß√µes

## üîß **Configura√ß√£o e Deploy**

### **Vari√°veis de Ambiente**
```json
{
  "ConnectionStrings": {
    "DefaultConnection": "SQL Server connection"
  },
  "PaymentGateways": {
    "CreditCard": {
      "Provider": "Stripe",
      "ApiKey": "your-stripe-key",
      "WebhookSecret": "webhook-secret"
    },
    "PIX": {
      "Provider": "BACEN",
      "CertificatePath": "certificate.p12",
      "Environment": "sandbox"
    }
  },
  "Security": {
    "EncryptionKey": "your-encryption-key",
    "TokenizationKey": "tokenization-key"
  }
}
```

### **Docker Setup**
```yaml
payments.api:
  image: paymentsapi
  container_name: FiapPayments
  ports: ["9201:80"]
  networks: [postech-network]
  depends_on: [sqlserver, rabbitmq]
```

## üß™ **Verifica√ß√£o de Funcionamento**

### **Testando os Endpoints**

**Swagger UI**: Acesse `http://localhost:9201/swagger` para testar todos os endpoints interativamente.

**Principais Testes**:
- **Transa√ß√£o**: `POST /api/v1/payments/transactions` com dados de cart√£o
- **Consulta**: `GET /api/v1/payments/transactions/{id}` 
- **Parcelamento**: `POST /api/v1/payments/installments/calculate`
- **Health**: `GET /health` para verificar status

### **Teste de Pagamento Completo**
```bash
# 1. Criar transa√ß√£o
curl -X POST http://localhost:9201/api/v1/payments/transactions \
  -H "Content-Type: application/json" \
  -d '{
    "amount": 100.00,
    "currency": "BRL",
    "paymentMethod": "credit_card",
    "cardNumber": "4111111111111111",
    "expiryMonth": "12",
    "expiryYear": "2025",
    "cvv": "123"
  }'

# 2. Processar pagamento
curl -X POST http://localhost:9201/api/v1/payments/process/{transactionId}

# 3. Consultar status
curl -X GET http://localhost:9201/api/v1/payments/transactions/{transactionId}
```

## üö® **Troubleshooting Completo**

### **Problemas de Pagamento**

**Gateway n√£o responde**:
1. Verificar conectividade com provedor
2. Validar chaves de API e certificados
3. Verificar logs de rede e timeouts

**Transa√ß√£o rejeitada**:
1. Verificar dados do cart√£o
2. Validar limites e disponibilidade
3. Verificar regras antifraude

### **Problemas de Infraestrutura**

**Performance lenta**:
1. Verificar traces no Jaeger para identificar gargalos
2. Monitorar m√©tricas no Grafana
3. Verificar load dos gateways externos

**Dados inconsistentes**:
1. Verificar logs de concilia√ß√£o
2. Executar relat√≥rios de auditoria
3. Verificar eventos publicados no RabbitMQ

## ‚úÖ **Requisitos FIAP Tech Challenge Atendidos**

### **Processamento de Pagamentos - 100% Implementado**
- ‚úÖ **M√∫ltiplos M√©todos**: Cart√£o, PIX, boleto, d√©bito
- ‚úÖ **Gateways Integrados**: M√∫ltiplos provedores suportados
- ‚úÖ **Seguran√ßa PCI**: Compliance com padr√µes financeiros
- ‚úÖ **Estados Controlados**: State machine para transa√ß√µes

### **Distributed Tracing - 100% Implementado**
- ‚úÖ **OpenTelemetry**: Instrumenta√ß√£o autom√°tica completa
- ‚úÖ **Jaeger**: Coleta e visualiza√ß√£o de traces distribu√≠dos
- ‚úÖ **Transaction Tracing**: Rastreamento completo do fluxo de pagamento
- ‚úÖ **Performance Monitoring**: Identifica√ß√£o de gargalos

### **Funcionalidades Extras Implementadas**
- üí≥ **Gateways M√∫ltiplos**: Abstra√ß√£o para diferentes provedores
- üìä **Analytics Financeiros**: Dashboards e relat√≥rios em tempo real
- üîê **Seguran√ßa Avan√ßada**: Tokeniza√ß√£o, criptografia, antifraude
- ‚öôÔ∏è **Observabilidade Completa**: ELK + Prometheus + Grafana + Jaeger
- üöÄ **Performance**: Processamento otimizado com retry policies

## üë• **Ecossistema FIAP Tech Challenge**

Este projeto faz parte da arquitetura de microservi√ßos:
- **üí≥ FiapPosTechPayments**: Microservi√ßo de pagamentos (este projeto)
- **üéÆ FiapPosTechGames**: Microservi√ßo de jogos com Elasticsearch
- **üë§ FiapPosTechUsers**: Microservi√ßo de usu√°rios e autentica√ß√£o
- **üöÄ FiapPosTechDocker**: Infraestrutura Docker compartilhada

## üìÑ **Documenta√ß√£o T√©cnica**

- **Swagger API**: `http://localhost:9201/swagger` (durante execu√ß√£o)
- **Arquitetura**: Clean Architecture com patterns financeiros
- **Compliance**: PCI DSS, LGPD, regulamenta√ß√µes BACEN

---

**üéÜ Microservi√ßo Payments com observabilidade completa em produ√ß√£o:**
- **Processamento seguro** de m√∫ltiplos m√©todos de pagamento
- **Distributed Tracing** com OpenTelemetry + Jaeger
- **Monitoramento completo** com Prometheus + Grafana + ELK Stack
- **Health checks** em todos os componentes e gateways